/*jshint white:false, onevar:false, boss:true, noarg:false *//*global test:false, stop:false, ok:false, hasher:false, module:false, equals:false, expect:false, start:false, same:false, console:false *//*
 *
 *      Hasher JS Unit test
 *
 *
 *      -----------------------------------------------------------------------
 *
 *      WARNING:
 *          - poor code ahead!
 *          - don't use as reference!
 *
 *      -----------------------------------------------------------------------
 *
 *      IMPORTANT:
 *          - unit test doesn't work properly on Chrome <= 6 because of browser bug:
 *            http://code.google.com/p/chromium/issues/detail?id=45419
 *
 *      -----------------------------------------------------------------------
 *
 */function doChangeTest(e){var t="#"+(e+1),n=testsHashs[e],r=e>0?testsHashs[e-1]:"";test(t,function(){stop(2e3);expect(9);hasher.init();ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.changed.add(function(e,t){ok(!0,"CHANGED dispatched");ok(t!==hasher.getHash(),"Hash value really changed.");hasher.changed.remove(arguments.callee);ok(!hasher.changed.getNumListeners(),"Removed CHANGED Listener");equals(t,r,"oldHash");equals(hasher.getHash(),e,"newHash == hasher.getHash()");start()});ok(hasher.changed.getNumListeners()===1,"Attached CHANGED Listener");hasher.setHash(n);equals(hasher.getHash(),n,"hasher.setHash() & hasher.getHash()");var e=n.split("/");same(hasher.getHashAsArray(),e,"hasher.getHashAsArray()")})}function doBackTest(e){var t="#"+(e+1),n=testsHashs[e],r=function(){stop((e+1)*TIMEOUT_BACK_FORWARD);expect(7);hasher.initialized.removeAll();hasher.stopped.removeAll();hasher.changed.removeAll();ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.changed.add(function(e,t){ok(!0,"CHANGED dispatched");hasher.changed.remove(arguments.callee);ok(!hasher.changed.getNumListeners(),"Removed CHANGED Listener");equals(hasher.getHash(),e,"newHash == hasher.getHash()");equals(hasher.getHash(),n,"hasher.getHash()");var r=n.split("/");same(hasher.getHashAsArray(),r,"hasher.getHashAsArray()");start()});ok(hasher.changed.getNumListeners(),"Attached CHANGED Listener");setTimeout(function(){window.history.back()},e*DELAY_BACK_FORWARD)};test(t,r)}function doForwardTest(e){var t="#"+(e+1),n=testsHashs[e],r=function(){stop((e+1)*TIMEOUT_BACK_FORWARD);expect(7);hasher.initialized.removeAll();hasher.stopped.removeAll();hasher.changed.removeAll();ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.changed.add(function(e,t){ok(!0,"CHANGED dispatched");hasher.changed.remove(arguments.callee);ok(!hasher.changed.getNumListeners(),"Removed CHANGED Listener");equals(hasher.getHash(),e,"newHash == hasher.getHash()");equals(hasher.getHash(),n,"hasher.getHash()");var r=n.split("/");same(hasher.getHashAsArray(),r,"hasher.getHashAsArray()");start()});ok(hasher.changed.getNumListeners(),"Attached CHANGED Listener");setTimeout(function(){window.history.forward()},e*DELAY_BACK_FORWARD)};test(t,r)}var DELAY_BACK_FORWARD=80,TIMEOUT_BACK_FORWARD=300;location.hash="";module("init and stop");test("init hasher",function(){stop(2e3);expect(4);ok(!hasher.initialized.getNumListeners(),"No INIT Listener");hasher.initialized.add(function(){ok(!0,"INIT dispatched");hasher.initialized.remove(arguments.callee);ok(!hasher.initialized.getNumListeners(),"Removed INIT Listener");start()});ok(hasher.initialized.getNumListeners(),"Added INIT Listener");hasher.init()});var stopTest=function(){stop(2e3);expect(5);hasher.init();ok(hasher.isActive(),"Is active");ok(!hasher.stopped.getNumListeners(),"No STOP Listener");hasher.stopped.add(function(e){ok(!0,"STOP dispatched");hasher.stopped.remove(arguments.callee);ok(!hasher.stopped.getNumListeners(),"Removed STOP Listener");start()});ok(hasher.stopped.getNumListeners(),"Attached STOP Listener");hasher.stop()},stopFailTest=function(){stop(2e3);expect(5);hasher.stop();ok(!hasher.isActive(),"Is not active");ok(!hasher.stopped.getNumListeners(),"No STOP Listener");var e=function(e){ok(!1,"STOP dispatched");hasher.stopped.removeAll();start()};hasher.stopped.add(e);ok(hasher.stopped.getNumListeners(),"Attached STOP Listener");hasher.stop();hasher.stop();var t=function(){ok(!0,"Didn't dispatched STOP event.");hasher.stopped.removeAll();ok(!hasher.stopped.getNumListeners(),"Removed STOP Listener");start()};setTimeout(t,100)},initTest=function(){stop(2e3);expect(6);hasher.stop();ok(!hasher.isActive(),"Is not active");ok(!hasher.initialized.getNumListeners(),"No INIT Listener");hasher.initialized.add(function(e){ok(hasher.isActive(),"Is active");ok(!0,"INIT dispatched");hasher.initialized.remove(arguments.callee);ok(!hasher.initialized.getNumListeners(),"Removed INIT Listener");start()});ok(hasher.initialized.getNumListeners(),"Attached INIT Listener");hasher.init()},initFailTest=function(){stop(2e3);expect(6);hasher.init();ok(hasher.isActive(),"Is active");ok(!hasher.initialized.getNumListeners(),"No INIT Listener");var e=function(e){ok(!1,"INIT dispatched");hasher.initialized.removeAll();start()};hasher.initialized.add(e);ok(hasher.initialized.getNumListeners(),"Attached INIT Listener");hasher.init();hasher.init();var t=function(){ok(!0,"Didn't dispatched INIT event.");ok(hasher.isActive(),"Is active");hasher.initialized.removeAll();ok(!hasher.initialized.getNumListeners(),"Removed INIT Listener");start()};setTimeout(t,100)};test("stop #1",stopTest);test("stop fail #1",stopFailTest);test("stop fail #2",stopFailTest);test("init #1",initTest);test("init fail #1",initFailTest);test("init fail #2",initFailTest);test("stop #2",stopTest);test("init #2",initTest);test("stop #3",stopTest);var testsHashs=["foo","dolor","sit-amet/ipsum/?dolor=ipsum&maecennas=ullamcor","Spëçíãl Çhàrs FTW","/asd","/asd/qwerty/","/asd/qwerty/?foo=bar","lorem-ipsum","foo%bar%"];module("set/get hash value");for(var i=0,t=testsHashs.length;i<t;i++)doChangeTest(i);module("back");var n=testsHashs.length-1;while(n--)doBackTest(n);module("forward");for(i=1;i<testsHashs.length;i++)doForwardTest(i);module();test("multiple listeners & changes",function(){function e(e){ok(!0,"Called Handler #1")}function t(e){ok(!0,"Called Handler #2")}function n(e){ok(!0,"Called Handler #3")}stop(2e3);expect(25);hasher.initialized.removeAll();hasher.stopped.removeAll();hasher.changed.removeAll();hasher.init();ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.changed.add(e);hasher.changed.add(t);hasher.changed.add(n);ok(hasher.changed.getNumListeners(),"Has CHANGED Listener");hasher.setHash("Lorem");equals(hasher.getHash(),"Lorem");hasher.setHash("Lorem/Ipsum");equals(hasher.getHash(),"Lorem/Ipsum");hasher.setHash("Lorem/Dolor&Amet/?foo=bar&ipsum=dolor&n=123&nan=abc123");equals(hasher.getHash(),"Lorem/Dolor&Amet/?foo=bar&ipsum=dolor&n=123&nan=abc123");hasher.setHash("?foo=bar&ipsum=dolor");equals(hasher.getHash(),"?foo=bar&ipsum=dolor");ok(!hasher.initialized.getNumListeners(),"No INIT Listener");hasher.initialized.add(function(e){ok(!1,"INIT event dispatched by accident")});ok(hasher.initialized.getNumListeners(),"Has INIT Listener");ok(!hasher.stopped.getNumListeners(),"No STOP Listener");hasher.stopped.add(function(e){ok(!1,"STOP event dispatched by accident")});ok(hasher.stopped.getNumListeners(),"Has STOP Listener");hasher.initialized.removeAll();ok(!hasher.initialized.getNumListeners(),"No INIT Listener");hasher.changed.removeAll();ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.stopped.removeAll();ok(!hasher.stopped.getNumListeners(),"No STOP Listener");hasher.setHash("");start()});test("set hash as rest param",function(){stop(500);hasher.init();var e=hasher.getHash(),t="lorem/ipsum/dolor/sit-amet";ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.changed.add(function(t,n){ok(!0,"CHANGED dispatched");ok(n!==hasher.getHash(),"Hash value really changed.");hasher.changed.remove(arguments.callee);ok(!hasher.changed.getNumListeners(),"Removed CHANGED Listener");equals(n,e,"oldHash");equals(hasher.getHash(),t,"newHash == hasher.getHash()");start()});ok(hasher.changed.getNumListeners()===1,"Attached CHANGED Listener");hasher.setHash("lorem","ipsum","dolor","sit-amet");equals(hasher.getHash(),t,"hasher.setHash() & hasher.getHash()");var n=t.split("/");same(hasher.getHashAsArray(),n,"hasher.getHashAsArray()")});test("prepend/append/separator",function(){stop(500);hasher.init();hasher.separator="_";hasher.prependHash="=";hasher.appendHash="=";var e=hasher.getHash(),t="lorem_ipsum_dolor_sit-amet";ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");hasher.changed.add(function(t,n){ok(!0,"CHANGED dispatched");ok(n!==hasher.getHash(),"Hash value really changed.");hasher.changed.remove(arguments.callee);ok(!hasher.changed.getNumListeners(),"Removed CHANGED Listener");equals(n,e,"oldHash");equals(hasher.getHash(),t,"newHash == hasher.getHash()");start()});ok(hasher.changed.getNumListeners()===1,"Attached CHANGED Listener");hasher.setHash("lorem","ipsum","dolor","sit-amet");equals(hasher.getHash(),t,"hasher.setHash() & hasher.getHash()");equals(window.location.hash,"#"+hasher.prependHash+t+hasher.appendHash,"append & prepend really works");var n=t.split("_");same(hasher.getHashAsArray(),n,"hasher.getHashAsArray()");hasher.separator="/";hasher.prependHash="/";hasher.appendHash=""});test("replaceHash",function(){function s(t,r){ok(!0,"CHANGED dispatched");hasher.changed.remove(s);hasher.changed.add(o);ok(r!==hasher.getHash(),"Hash value really changed.");equals(r,n[e],"oldHash");equals(hasher.getHash(),t,"newHash == hasher.getHash()");e+=1;if(e===2){hasher.changed.removeAll();start()}else setTimeout(function(){window.history.back()},DELAY_BACK_FORWARD)}function o(n,u){ok(!0,"CHANGED dispatched");hasher.changed.remove(o);hasher.changed.add(s);ok(u!==hasher.getHash(),"Hash value really changed.");equals(u,i[t],"oldHash");equals(hasher.getHash(),n,"newHash == hasher.getHash()");equals(r[t],n,"newHash == _prevs[_countBack]");t+=1;setTimeout(function(){hasher.replaceHash(i[e])},DELAY_BACK_FORWARD)}stop(500);expect(13);var e=0,t=0,n=["=lorem_ipsum_dolor_sit-amet=","lorem/ipsum/dolor/sit-amet"],r=["lorem/ipsum/dolor/sit-amet"],i=["foo/bar","dolor/123"];hasher.changed.add(s);hasher.replaceHash(i[0])});module();test("multiple redirects [issue #39]",function(){stop(1500);expect(9);hasher.init();var e=0,t=function(t,r){e+=1;equals(hasher.getHash(),t,"hasher.getHash() === newHash");if(t==="zero"){equals(r,"",'prevHash === ""');hasher.replaceHash("one")}else if(t==="one"){equals(r,"zero",'prevHash === "zero"');hasher.replaceHash("two")}else{equals(r,"one",'prevHash === "one"');equals(t,"two",'newHash === "two"')}};hasher.replaceHash("");hasher.changed.add(t);hasher.replaceHash("zero");setTimeout(function(){hasher.changed.remove(t);equals(e,3,"only changed 3 times");equals(window.location.hash,"#/two","updated location.hash");start()},1200)});module();test("IE8 local + hash query [issue #6]",function(){stop(1500);expect(9);var e=0,t=function(t,n){ok(t!==n,"hash changed");ok(t.indexOf("?")!==-1,"has hash query");e++};hasher.changed.add(t);hasher.setHash("foo?lorem=ipsum");setTimeout(function(){hasher.setHash("foo?lorem=amet");setTimeout(function(){var n=hasher.changed.add(function(r,i){n.detach();equals(r,"foo?lorem=ipsum","new hash");equals(i,"foo?lorem=amet","old hash");hasher.changed.remove(t);equals(e,3,"count");start()});window.history.back()},DELAY_BACK_FORWARD)},DELAY_BACK_FORWARD)});test("appendHash + $ [issue #49]",function(){stop(2e3);hasher.init();ok(!hasher.changed.getNumListeners(),"No CHANGED Listener");var e=function(e,t){ok(e!==t,"hash changed");equals(e,"foo$bar","new hash")};hasher.changed.add(e);hasher.appendHash="";hasher.setHash("foo$bar");setTimeout(function(){hasher.changed.remove(e);hasher.changed.add(function(e,t){equals(e,"foo$lorem=amet","new hash");equals(t,"foo$bar","old hash");hasher.changed.removeAll();start()});setTimeout(function(){hasher.setHash("foo$lorem=amet")},DELAY_BACK_FORWARD)},DELAY_BACK_FORWARD)});module();test("dispose",function(){stop(500);expect(3);ok(hasher,"hasher exists");hasher.dispose();ok(!hasher,"! hasher");ok(hasher==null,"hasher == null");start()});